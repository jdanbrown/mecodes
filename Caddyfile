{
  # Fly.io terminates TLS at the edge, so Caddy sees HTTP on :8080
  auto_https off
}

:8080 {
  # HTTP Basic Auth â€” skip /admin/health so Fly's health check can reach it
  @authed not path /admin/health
  basic_auth @authed {
    {$CADDY_AUTH_USER} {$CADDY_AUTH_HASH}
  }

  # Sidecar API
  handle /admin/* {
    reverse_proxy localhost:4097
  }

  # Our frontend (static files), falling through to opencode API.
  # try_files serves our file if it exists, otherwise proxies to opencode.
  # This lets / serve our index.html while /session/*, /event, etc. reach the API.
  # app.opencode.ai also works: point it at this server, API routes pass through,
  # and its own assets come from app.opencode.ai directly (not from our static files).
  root * /opt/mecodes/frontend
  @static file
  handle @static {
    file_server
  }
  handle {
    reverse_proxy localhost:4096
  }
}
