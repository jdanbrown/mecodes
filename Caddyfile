{
  # Fly.io terminates TLS at the edge, so Caddy sees HTTP on :8080
  auto_https off
}

:8080 {

  # Auth: cookie-based via sidecar's forward_auth check.
  # Skip health check (Fly) and auth endpoints (login page + form submit).
  @protected not path /admin/health /auth/*
  forward_auth @protected localhost:4097 {
    uri /auth/check
  }

  # Sidecar API (includes /auth/* and /admin/*)
  handle /auth/* {
    reverse_proxy localhost:4097
  }
  handle /admin/* {
    reverse_proxy localhost:4097
  }

  # Our frontend (static files), falling through to opencode API.
  # try_files serves our file if it exists, otherwise proxies to opencode.
  # This lets / serve our index.html while /session/*, /event, etc. reach the API.
  # Unmatched paths (e.g. /session/abc) fall through to opencode, which proxies
  # to app.opencode.ai â€” so the opencode web UI is available at any non-file path.
  root * /opt/mecodes/frontend
  @static file {
    try_files {path} {path}/index.html
  }
  handle @static {
    file_server
  }
  handle {
    reverse_proxy localhost:4096
  }

}
