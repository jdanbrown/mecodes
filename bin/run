#!/usr/bin/env bash
set -euo pipefail

function echo_black_stderr() {
  black="`tput setaf 0`"
  off="`tput sgr0`"
  echo -e "$black$@$off" >&2
}

function show_cmd() {
  echo_black_stderr "\$" "$@"
  "$@"
}

echo_black_stderr "Start: run"

# Ensure volume dirs exist
mkdir -p /vol/projects /vol/opencode-state

# Hash the plaintext password for Caddy's basic_auth
# - Allow empty for local dev
if [ -n "${CADDY_AUTH_PASSWORD:-}" ]; then
  export CADDY_AUTH_HASH="$(caddy hash-password --plaintext "$CADDY_AUTH_PASSWORD")"
fi

echo_black_stderr "Starting opencode (bg)"
show_cmd opencode serve --hostname 0.0.0.0 --port 4096 &
OPENCODE_PID=$!

echo_black_stderr "Starting sidecar (bg)"
show_cmd /opt/mecodes/sidecar/.venv/bin/uvicorn sidecar.app:app --host 0.0.0.0 --port 4097 --log-level info &
SIDECAR_PID=$!

echo_black_stderr "Waiting for opencode to be ready..."
for i in $(seq 1 60); do
  if show_cmd curl -sf http://localhost:4096/global/health >/dev/null; then
    break
  fi
  sleep 0.5
done

# Caddy starts last â€” Fly's health check targets /admin/health (sidecar), which
# itself checks opencode liveness. So the deploy isn't "ready" until the whole
# stack is up: opencode + sidecar + caddy.
echo_black_stderr "Running caddy (fg)"
show_cmd exec caddy run --config /opt/mecodes/Caddyfile
