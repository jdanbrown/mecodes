#!/usr/bin/env bash
set -euo pipefail

function echo_black_stderr() {
  # Use 2>/dev/null with tput to silence this headless error: "tput: No value for $TERM and no -T specified"
  black="$(tput setaf 0 2>/dev/null || true)"
  off="$(tput sgr0 2>/dev/null || true)"
  echo -e "$black$@$off" >&2
}

function show_cmd() {
  echo_black_stderr "\$" "$@"
  "$@"
}

echo_black_stderr "Start: run"

# Ensure volume dirs exist
mkdir -p /vol/projects /vol/opencode-state

# Write build version for the frontend to display
GIT_SHA="$(cat /opt/mecodes/VERSION 2>/dev/null || echo 'dev')"
GIT_TIME="$(cat /opt/mecodes/VERSION_TIME 2>/dev/null || date -u +%Y-%m-%dT%H:%M:%SZ)"
echo "{\"sha\":\"${GIT_SHA}\",\"time\":\"${GIT_TIME}\"}" > /opt/mecodes/frontend/version.json

echo_black_stderr "Starting opencode (bg)"
show_cmd opencode serve --hostname 0.0.0.0 --port 4096 &
OPENCODE_PID=$!

echo_black_stderr "Starting sidecar (bg)"
show_cmd /opt/mecodes/sidecar/.venv/bin/uvicorn sidecar.app:app --host 0.0.0.0 --port 4097 --log-level info &
SIDECAR_PID=$!

echo_black_stderr "Waiting for opencode to be ready..."
for i in $(seq 1 60); do
  if show_cmd curl -sf http://localhost:4096/global/health >/dev/null; then
    break
  fi
  sleep 0.5
done

# Caddy starts last â€” Fly's health check targets /admin/health (sidecar), which
# itself checks opencode liveness. So the deploy isn't "ready" until the whole
# stack is up: opencode + sidecar + caddy.
echo_black_stderr "Running caddy (fg)"
show_cmd exec caddy run --config /opt/mecodes/Caddyfile
