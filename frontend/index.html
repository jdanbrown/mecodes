<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>mecodes</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0d1117;
      --bg2: #161b22;
      --bg3: #21262d;
      --border: #30363d;
      --text: #c9d1d9;
      --dim: #8b949e;
      --blue: #58a6ff;
      --green: #3fb950;
      --red: #f85149;
      --orange: #d29922;
    }
    body {
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Status bar */
    .status-bar {
      padding: 0.3rem 1rem;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
      font-size: 0.72rem;
      color: var(--dim);
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-shrink: 0;
    }
    .dot {
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--dim);
      margin-right: 3px;
      vertical-align: middle;
    }
    .dot.ok { background: var(--green); }
    .dot.err { background: var(--red); }
    #sseStatus { margin-left: auto; }

    /* App layout */
    .app { display: flex; flex: 1; overflow: hidden; }

    /* Sidebar */
    .sidebar {
      width: 260px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--bg2);
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sidebar-header h1 { font-size: 1rem; font-weight: 600; flex: 1; }
    .session-list { flex: 1; overflow-y: auto; }
    .session-empty { padding: 1rem; font-size: 0.8rem; color: var(--dim); text-align: center; }
    .session-item {
      padding: 0.7rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .session-item:hover { background: var(--bg3); }
    .session-item.active { background: var(--bg3); border-left: 3px solid var(--blue); padding-left: calc(1rem - 3px); }
    .session-info { flex: 1; overflow: hidden; }
    .session-title { font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .session-dir { font-size: 0.72rem; color: var(--dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 1px; }
    .session-del {
      opacity: 0;
      background: none;
      border: none;
      color: var(--red);
      cursor: pointer;
      padding: 2px 4px;
      font-size: 0.8rem;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .session-item:hover .session-del { opacity: 1; }
    .session-del:hover { background: var(--bg); }

    /* New session form */
    .new-session-form {
      padding: 0.875rem 1rem;
      border-top: 1px solid var(--border);
      display: none;
      flex-direction: column;
      gap: 0.5rem;
    }
    .new-session-form.visible { display: flex; }
    .form-label { font-size: 0.75rem; color: var(--dim); }
    .form-input {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 6px;
      padding: 0.5rem 0.625rem;
      font-size: 0.8rem;
      font-family: inherit;
    }
    .form-input:focus { outline: none; border-color: var(--blue); }
    .form-input::placeholder { color: var(--dim); }

    /* Main */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
    .chat-header {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-height: 48px;
      flex-shrink: 0;
    }
    .chat-title { font-size: 0.875rem; color: var(--dim); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .chat-title.active { color: var(--text); }
    .abort-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--orange);
      border-radius: 5px;
      padding: 0.3rem 0.6rem;
      font-size: 0.75rem;
      cursor: pointer;
      display: none;
    }
    .abort-btn.visible { display: block; }
    .abort-btn:hover { background: var(--bg3); }

    /* Messages */
    .messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.875rem; }
    .msg { max-width: 82%; padding: 0.7rem 0.875rem; border-radius: 10px; font-size: 0.875rem; line-height: 1.65; white-space: pre-wrap; word-break: break-word; }
    .msg.user { background: var(--blue); color: #fff; align-self: flex-end; border-bottom-right-radius: 3px; }
    .msg.assistant { background: var(--bg2); align-self: flex-start; border-bottom-left-radius: 3px; }
    .msg.tool { background: var(--bg3); align-self: flex-start; color: var(--dim); font-size: 0.78rem; font-family: monospace; border-radius: 6px; max-width: 90%; }
    .msg-role { font-size: 0.68rem; color: var(--dim); margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.04em; }
    .msg.user .msg-role { color: rgba(255,255,255,0.6); }

    /* Streaming cursor */
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
    .cursor { display: inline-block; width: 2px; height: 1em; background: var(--text); vertical-align: text-bottom; animation: blink 1s infinite; margin-left: 1px; }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      color: var(--dim);
      text-align: center;
      padding: 2rem;
    }
    .empty-state h2 { font-size: 1.25rem; color: var(--text); }
    .empty-state p { font-size: 0.875rem; }

    /* Input area */
    .input-area {
      padding: 0.875rem 1rem;
      border-top: 1px solid var(--border);
      display: none;
      gap: 0.5rem;
      align-items: flex-end;
    }
    .input-area.visible { display: flex; }
    .prompt-wrap { flex: 1; position: relative; }
    textarea {
      width: 100%;
      background: var(--bg2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 0.7rem 0.875rem;
      font-size: 0.875rem;
      resize: none;
      font-family: inherit;
      min-height: 44px;
      max-height: 180px;
      overflow-y: auto;
      display: block;
    }
    textarea:focus { outline: none; border-color: var(--blue); }
    textarea::placeholder { color: var(--dim); }

    /* Buttons */
    .btn {
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.7rem 1.1rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .btn-sm {
      background: var(--bg3);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.35rem 0.75rem;
      cursor: pointer;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .btn-sm:hover { background: var(--border); }
    .btn-sm.active { background: var(--border); border-color: var(--blue); color: var(--blue); }

    /* Mobile */
    .menu-btn { display: none; background: none; border: none; color: var(--text); cursor: pointer; padding: 0.25rem 0.5rem; font-size: 1.1rem; flex-shrink: 0; }
    @media (max-width: 600px) {
      .menu-btn { display: block; }
      .sidebar {
        position: absolute;
        z-index: 200;
        height: 100%;
        top: 0;
        left: 0;
        transform: translateX(-100%);
        transition: transform 0.2s ease;
        box-shadow: 4px 0 16px rgba(0,0,0,0.4);
      }
      .sidebar.open { transform: translateX(0); }
      .overlay {
        display: none;
        position: absolute;
        z-index: 199;
        inset: 0;
        background: rgba(0,0,0,0.5);
      }
      .overlay.visible { display: block; }
    }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<div class="status-bar">
  <span id="buildVersion" style="opacity:0.5"></span>
  <span><span class="dot" id="dotOc"></span>opencode</span>
  <span><span class="dot" id="dotSc"></span>sidecar</span>
  <a href="/foo" target="_blank" style="color:var(--dim);text-decoration:none;opacity:0.7" title="Open opencode web UI">opencode web ↗</a>
  <span id="sseStatus"></span>
</div>

<div class="app">
  <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1>mecodes</h1>
      <button class="btn-sm" id="newBtn">+ New</button>
    </div>
    <div class="session-list" id="sessionList">
      <div class="session-empty">Loading…</div>
    </div>
    <div class="new-session-form" id="newForm">
      <div class="form-label">Working directory (optional)</div>
      <input class="form-input" id="dirInput" placeholder="/vol/projects/…" autocomplete="off" spellcheck="false">
      <button class="btn" id="createBtn">Create Session</button>
    </div>
  </div>

  <div class="main">
    <div class="chat-header">
      <button class="menu-btn" id="menuBtn">☰</button>
      <span class="chat-title" id="chatTitle">Select a session</span>
      <button class="abort-btn" id="abortBtn">■ Stop</button>
    </div>

    <div class="messages" id="messages">
      <div class="empty-state">
        <h2>mecodes</h2>
        <p>Select a session or create a new one</p>
      </div>
    </div>

    <div class="input-area" id="inputArea">
      <div class="prompt-wrap">
        <textarea id="prompt" placeholder="Ask anything… (Enter to send, Shift+Enter for newline)" rows="1"></textarea>
      </div>
      <button class="btn" id="sendBtn">Send</button>
    </div>
  </div>
</div>

<script>
// --- State ---
let sessions = [];
let currentId = null;
let messages = {};   // sessionId -> [{id, role, parts}]
let streaming = {};  // sessionId -> {msgId -> accumulated text}
let generating = {}; // sessionId -> bool
let sse = null;

// --- API ---
async function api(method, path, body) {
  const opts = { method, headers: {} };
  if (body !== undefined) {
    opts.headers["Content-Type"] = "application/json";
    opts.body = JSON.stringify(body);
  }
  const r = await fetch(path, opts);
  if (!r.ok) {
    const txt = await r.text().catch(() => "");
    throw new Error(`${r.status}: ${txt}`);
  }
  if (r.status === 204 || r.headers.get("content-length") === "0") return null;
  const ct = r.headers.get("content-type") || "";
  if (ct.includes("application/json")) return r.json();
  return null;
}
const get  = (p)    => api("GET",    p);
const post = (p, b) => api("POST",   p, b);
const del  = (p)    => api("DELETE", p);

// --- Health ---
async function checkHealth() {
  for (const [url, dot] of [["/health", "dotOc"], ["/admin/health", "dotSc"]]) {
    try {
      await get(url);
      document.getElementById(dot).className = "dot ok";
    } catch {
      document.getElementById(dot).className = "dot err";
    }
  }
}

// --- Sessions ---
async function loadSessions() {
  try {
    const data = await get("/session");
    // opencode may return array directly or {sessions:[...]}
    sessions = Array.isArray(data) ? data : (data?.sessions ?? []);
    renderSessionList();
  } catch (e) {
    console.error("loadSessions:", e);
    setSessionListHTML('<div class="session-empty">Failed to load sessions</div>');
  }
}

async function createSession() {
  const dir = document.getElementById("dirInput").value.trim() || undefined;
  document.getElementById("createBtn").disabled = true;
  try {
    const s = await post("/session", dir ? { directory: dir } : {});
    // Avoid duplicates if SSE already added it
    if (!sessions.find(x => x.id === s.id)) sessions.unshift(s);
    renderSessionList();
    await selectSession(s.id);
    closeNewForm();
  } catch (e) {
    alert("Failed to create session: " + e.message);
  } finally {
    document.getElementById("createBtn").disabled = false;
  }
}

async function deleteSession(id, ev) {
  ev.stopPropagation();
  if (!confirm("Delete this session?")) return;
  try {
    await del(`/session/${id}`);
  } catch (e) {
    // 404 is fine — already gone
    if (!e.message.startsWith("404")) { alert("Failed: " + e.message); return; }
  }
  sessions = sessions.filter(s => s.id !== id);
  delete messages[id];
  delete streaming[id];
  if (currentId === id) { currentId = null; renderMain(); }
  renderSessionList();
}

async function selectSession(id) {
  currentId = id;
  renderSessionList();
  renderMain();
  closeSidebar();
  if (!messages[id]) await fetchMessages(id);
  renderMessages();
}

async function fetchMessages(id) {
  try {
    const data = await get(`/session/${id}`);
    // opencode returns session object; messages are in data.messages or nested
    const msgs = data?.messages ?? data?.chat?.messages ?? [];
    messages[id] = msgs;
  } catch (e) {
    console.error("fetchMessages:", e);
    messages[id] = [];
  }
}

async function sendPrompt() {
  const ta = document.getElementById("prompt");
  const text = ta.value.trim();
  if (!text || !currentId) return;

  ta.value = "";
  autoResize(ta);
  setSending(true);

  // Optimistic user message
  if (!messages[currentId]) messages[currentId] = [];
  messages[currentId].push({ id: `opt-${Date.now()}`, role: "user", parts: [{ type: "text", text }] });
  renderMessages();

  try {
    await post(`/session/${currentId}/prompt_async`, {
      content: [{ type: "text", text }],
    });
    generating[currentId] = true;
    renderAbortBtn();
  } catch (e) {
    setSending(false);
    alert("Send failed: " + e.message);
  }
}

async function abortSession() {
  if (!currentId) return;
  try {
    await post(`/session/${currentId}/abort`);
  } catch (e) {
    console.warn("abort:", e);
  }
  generating[currentId] = false;
  setSending(false);
  renderAbortBtn();
}

// --- SSE ---
function connectSSE() {
  if (sse) sse.close();
  sse = new EventSource("/event");

  sse.onopen = () => {
    const el = document.getElementById("sseStatus");
    el.textContent = "● live";
    el.style.color = "var(--green)";
  };
  sse.onerror = () => {
    const el = document.getElementById("sseStatus");
    el.textContent = "○ reconnecting";
    el.style.color = "var(--orange)";
  };
  sse.onmessage = ev => handleEvent(ev.data);

  // Named event types opencode may emit
  for (const t of ["message", "session", "session.created", "session.updated",
                    "message.created", "message.updated", "message.part",
                    "assistant.streaming", "assistant.done"]) {
    sse.addEventListener(t, ev => handleEvent(ev.data));
  }
}

function handleEvent(raw) {
  let ev;
  try { ev = JSON.parse(raw); } catch { return; }
  if (!ev) return;

  const type = ev.type ?? ev.event ?? "";
  const sid = ev.sessionId ?? ev.session_id ?? ev.session?.id ?? null;

  // Session list updates
  if (type.includes("session") && ev.session) {
    const idx = sessions.findIndex(s => s.id === ev.session.id);
    if (idx >= 0) sessions[idx] = ev.session;
    else if (type.includes("created")) sessions.unshift(ev.session);
    renderSessionList();
    if (ev.session.id === currentId) renderChatTitle();
  }

  // Message upsert
  if (ev.message && sid) {
    if (!messages[sid]) messages[sid] = [];
    const list = messages[sid];
    const idx = list.findIndex(m => m.id === ev.message.id);
    if (idx >= 0) list[idx] = ev.message;
    else list.push(ev.message);
    // Clear streaming for this message once it's committed
    if (streaming[sid]?.[ev.message.id]) delete streaming[sid][ev.message.id];
    if (sid === currentId) renderMessages();
  }

  // Streaming text parts
  if (type === "message.part" && sid && ev.part) {
    const msgId = ev.messageId ?? ev.message_id ?? "_stream";
    if (!streaming[sid]) streaming[sid] = {};
    if (ev.part.type === "text") {
      streaming[sid][msgId] = (streaming[sid][msgId] ?? "") + (ev.part.text ?? "");
    }
    if (sid === currentId) renderMessages();
  }

  // Done signal
  if (type === "assistant.done" || (type === "message.updated" && ev.message?.status === "done")) {
    if (sid) {
      generating[sid] = false;
      if (streaming[sid]) delete streaming[sid];
    }
    if (sid === currentId) {
      setSending(false);
      renderAbortBtn();
      // Refresh messages to get final content
      fetchMessages(currentId).then(() => renderMessages());
    }
  }
}

// --- Render ---
function renderSessionList() {
  if (!sessions.length) {
    setSessionListHTML('<div class="session-empty">No sessions yet</div>');
    return;
  }
  setSessionListHTML(sessions.map(s => {
    const active = s.id === currentId ? " active" : "";
    const title = s.title || s.id?.slice(0, 14) || "untitled";
    const dir = s.directory ? trimDir(s.directory) : "";
    return `<div class="session-item${active}" onclick="selectSession('${esc(s.id)}')">
      <div class="session-info">
        <div class="session-title">${esc(title)}</div>
        ${dir ? `<div class="session-dir">${esc(dir)}</div>` : ""}
      </div>
      <button class="session-del" onclick="deleteSession('${esc(s.id)}', event)" title="Delete">✕</button>
    </div>`;
  }).join(""));
}

function setSessionListHTML(html) {
  document.getElementById("sessionList").innerHTML = html;
}

function renderMain() {
  const inputArea = document.getElementById("inputArea");
  if (!currentId) {
    inputArea.classList.remove("visible");
    document.getElementById("messages").innerHTML =
      `<div class="empty-state"><h2>mecodes</h2><p>Select a session or create a new one</p></div>`;
    document.getElementById("chatTitle").textContent = "Select a session";
    document.getElementById("chatTitle").className = "chat-title";
    renderAbortBtn();
    return;
  }
  inputArea.classList.add("visible");
  renderChatTitle();
  renderAbortBtn();
}

function renderChatTitle() {
  const s = sessions.find(s => s.id === currentId);
  const title = s?.title || currentId?.slice(0, 16) || "Session";
  const dir = s?.directory ? ` — ${trimDir(s.directory)}` : "";
  const el = document.getElementById("chatTitle");
  el.textContent = title + dir;
  el.className = "chat-title active";
}

function renderAbortBtn() {
  const btn = document.getElementById("abortBtn");
  if (currentId && generating[currentId]) btn.classList.add("visible");
  else btn.classList.remove("visible");
}

function renderMessages() {
  if (!currentId) return;
  const container = document.getElementById("messages");
  const msgs = messages[currentId] ?? [];
  const stream = streaming[currentId] ?? {};
  const atBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 60;

  let html = "";
  const renderedMsgIds = new Set();

  for (const msg of msgs) {
    const streamText = stream[msg.id];
    const rendered = renderMsg(msg, streamText);
    if (rendered) { html += rendered; renderedMsgIds.add(msg.id); }
  }

  // Orphan streaming parts (msg not yet in list)
  for (const [msgId, text] of Object.entries(stream)) {
    if (!renderedMsgIds.has(msgId) && text) {
      html += `<div class="msg assistant"><div class="msg-role">assistant</div>${esc(text)}<span class="cursor"></span></div>`;
    }
  }

  if (!html && msgs.length === 0) {
    html = `<div style="color:var(--dim);font-size:0.875rem;text-align:center;padding:3rem">Session started — send a message to begin</div>`;
  }

  container.innerHTML = html;
  if (atBottom) container.scrollTop = container.scrollHeight;
}

function renderMsg(msg, streamText) {
  const role = msg.role ?? "assistant";
  const parts = msg.parts ?? msg.content ?? [];
  let text = "";

  if (typeof parts === "string") {
    text = parts;
  } else if (Array.isArray(parts)) {
    for (const p of parts) {
      if (p.type === "text") text += p.text ?? "";
      else if (p.type === "tool-invocation" || p.type === "tool-use") {
        const name = p.toolName ?? p.name ?? "tool";
        const input = JSON.stringify(p.input ?? p.args ?? {});
        text += `[${name}(${input.length > 100 ? input.slice(0, 100) + "…" : input})]`;
      } else if (p.type === "tool-result") {
        const content = p.content;
        const preview = typeof content === "string" ? content : JSON.stringify(content);
        text += `[result: ${preview.length > 120 ? preview.slice(0, 120) + "…" : preview}]`;
      }
    }
  }

  // Append any in-progress streaming text for this message
  if (streamText && !text.endsWith(streamText)) text += streamText;
  const hasCursor = !!streamText;

  if (!text && !hasCursor) return "";

  const cls = role === "user" ? "user" : role === "tool" ? "tool" : "assistant";
  const cursor = hasCursor ? '<span class="cursor"></span>' : "";
  return `<div class="msg ${cls}"><div class="msg-role">${esc(role)}</div>${esc(text)}${cursor}</div>`;
}

// --- UI helpers ---
function esc(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

function trimDir(dir) {
  const parts = dir.split("/").filter(Boolean);
  return parts.slice(-2).join("/");
}

function setSending(on) {
  document.getElementById("sendBtn").disabled = on;
  document.getElementById("prompt").disabled = on;
}

function autoResize(el) {
  el.style.height = "auto";
  el.style.height = Math.min(el.scrollHeight, 180) + "px";
}

function toggleNewForm() {
  const f = document.getElementById("newForm");
  f.classList.toggle("visible");
  if (f.classList.contains("visible")) document.getElementById("dirInput").focus();
  document.getElementById("newBtn").classList.toggle("active", f.classList.contains("visible"));
}

function closeNewForm() {
  document.getElementById("newForm").classList.remove("visible");
  document.getElementById("newBtn").classList.remove("active");
  document.getElementById("dirInput").value = "";
}

function closeSidebar() {
  document.getElementById("sidebar").classList.remove("open");
  document.getElementById("overlay").classList.remove("visible");
}

// --- Wire up ---
document.getElementById("newBtn").onclick = toggleNewForm;
document.getElementById("createBtn").onclick = createSession;
document.getElementById("sendBtn").onclick = sendPrompt;
document.getElementById("abortBtn").onclick = abortSession;
document.getElementById("menuBtn").onclick = () => {
  document.getElementById("sidebar").classList.toggle("open");
  document.getElementById("overlay").classList.toggle("visible");
};
document.getElementById("dirInput").addEventListener("keydown", e => {
  if (e.key === "Enter") createSession();
});
document.getElementById("prompt").addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
});
document.getElementById("prompt").addEventListener("input", function() { autoResize(this); });

// Expose for inline onclick handlers
window.selectSession = selectSession;
window.deleteSession = deleteSession;

// --- Init ---
checkHealth();
loadSessions();
connectSSE();
setInterval(checkHealth, 30_000);

fetch("/version.json").then(r => r.json()).then(v => {
  document.getElementById("buildVersion").textContent = `${v.sha} (${v.time})`;
}).catch(() => {});
</script>
</body>
</html>
