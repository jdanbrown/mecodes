#!/usr/bin/env bash
set -euo pipefail

echo "=== mecodes entrypoint ==="

# Ensure volume dirs exist
mkdir -p /vol/projects /vol/opencode-state

# Hash the plaintext password for Caddy's basic_auth
export CADDY_AUTH_HASH=$(caddy hash-password --plaintext "$CADDY_AUTH_PASSWORD")

# Start opencode serve (background)
echo "Starting opencode serve..."
opencode serve --hostname 0.0.0.0 --port 4096 &
OPENCODE_PID=$!

# Start sidecar (background)
echo "Starting sidecar..."
/opt/mecodes/sidecar/.venv/bin/uvicorn sidecar.app:app \
  --host 0.0.0.0 --port 4097 --log-level info &
SIDECAR_PID=$!

# Wait for opencode to be ready
for i in $(seq 1 30); do
  if curl -sf http://localhost:4096/health > /dev/null 2>&1; then
    echo "opencode serve is ready"
    break
  fi
  sleep 1
done

# Start Caddy (foreground â€” the main process)
echo "Starting Caddy..."
exec caddy run --config /opt/mecodes/Caddyfile
